<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Houston County Market Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Optional simple styles for cards and arrows */
    .metric-container { display: flex; gap: 20px; flex-wrap: wrap; }
    .metric { background: #f5f5f5; padding: 10px 15px; border-radius: 6px; flex: 1 1 150px; }
    .arrow.up { color: green; } 
    .arrow.down { color: red; } 
    .arrow.flat { color: gray; }
    .insight-cards { display: flex; gap: 10px; flex-wrap: wrap; }
    .insight-card { padding: 10px 15px; border-radius: 6px; background: #eee; flex: 1 1 200px; }
    .positive { border-left: 5px solid green; }
    .negative { border-left: 5px solid red; }
    .neutral { border-left: 5px solid gray; }
    header h1 { display: flex; justify-content: space-between; align-items: center; }
    #version { font-size: 0.9em; color: #555; margin-left: 15px; }
  </style>
</head>
<body>
  <header>
    <h1>
      Houston County Real Estate Dashboard
      <span id="version">v1.0</span>
    </h1>
    <div>
      <label for="zipSelect">Select ZIP:</label>
      <select id="zipSelect"></select>
    </div>
  </header>

  <main>
    <section id="metrics">
      <h2>Market Metrics</h2>
      <div class="metric-container">
        <div class="metric">
          <h3>Median List Price</h3>
          <p id="medianList">$0 <span id="medianListArrow"></span></p>
        </div>
        <div class="metric">
          <h3>Median Sale Price</h3>
          <p id="medianSale">$0 <span id="medianSaleArrow"></span></p>
        </div>
        <div class="metric">
          <h3>Inventory</h3>
          <p id="inventory">0 <span id="inventoryArrow"></span></p>
        </div>
        <div class="metric">
          <h3>Trend</h3>
          <p id="trend">N/A</p>
        </div>
      </div>
    </section>

    <section id="charts">
      <h2>Trends</h2>
      <canvas id="priceChart" width="600" height="250"></canvas>
      <canvas id="inventoryChart" width="600" height="250"></canvas>
    </section>

    <section id="insights">
      <h2>Weekly Insights</h2>
      <div id="insightsList" class="insight-cards"></div>
    </section>
  </main>

  <script src="charts.js"></script>
  <script>
    const zipSelect = document.getElementById("zipSelect");
    let allData = {};
    const versionSpan = document.getElementById("version");

    // Update version dynamically (increment manually when code changes)
    const DASHBOARD_VERSION = "v1.1";
    versionSpan.innerText = DASHBOARD_VERSION;

    async function loadDataJSON() {
      try {
        const response = await fetch('data/houston-county-ga/market_all_zips.json');
        allData = await response.json();

        // Populate ZIP dropdown
        zipSelect.innerHTML = '';
        Object.keys(allData).forEach(zip => {
          const option = document.createElement('option');
          option.value = zip;
          option.innerText = `${zip} - ${allData[zip].city}`;
          zipSelect.appendChild(option);
        });

        loadZIP(zipSelect.value);

      } catch (err) {
        console.error("Failed to load market JSON:", err);
      }
    }

    function setArrow(elementId, change) {
      const el = document.getElementById(elementId);
      if (change > 0) el.innerHTML = '<span class="arrow up">⬆️</span>';
      else if (change < 0) el.innerHTML = '<span class="arrow down">⬇️</span>';
      else el.innerHTML = '<span class="arrow flat">➡️</span>';
    }

    function loadZIP(zip) {
      const data = allData[zip];
      if (!data) return;

      // Metrics
      const lastListChange = data.history.median_list.slice(-1)[0] - data.history.median_list.slice(-2)[0];
      document.getElementById("medianList").innerText = `$${data.pricing.median_list.toLocaleString()}`;
      setArrow("medianListArrow", lastListChange);

      const lastSaleChange = data.history.median_sale ? data.history.median_sale.slice(-1)[0] - data.history.median_sale.slice(-2)[0] : 0;
      document.getElementById("medianSale").innerText = `$${data.pricing.median_sale.toLocaleString()}`;
      setArrow("medianSaleArrow", lastSaleChange);

      const lastInventoryChange = data.history.inventory ? data.history.inventory.slice(-1)[0] - data.history.inventory.slice(-2)[0] : 0;
      document.getElementById("inventory").innerText = data.inventory.active.toLocaleString();
      setArrow("inventoryArrow", lastInventoryChange);

      document.getElementById("trend").innerText = data.pricing.trend;

      // Insights
      const insightsDiv = document.getElementById("insightsList");
      insightsDiv.innerHTML = '';
      data.weekly_insights.forEach(point => {
        const card = document.createElement("div");
        card.className = "insight-card";
        card.innerText = point.text || point; // fallback for older data
        if(point.type === 'positive') card.classList.add('positive');
        else if(point.type === 'negative') card.classList.add('negative');
        else card.classList.add('neutral');
        insightsDiv.appendChild(card);
      });

      // Charts
      renderLine(
        "priceChart",
        data.history.median_list,
        data.history.median_sale,
        "Price ($)"
      );

      renderLine(
        "inventoryChart",
        data.history.inventory || Array(data.history.median_list.length).fill(data.inventory.active),
        null,
        "Inventory"
      );
    }

    zipSelect.addEventListener("change", () => loadZIP(zipSelect.value));
    loadDataJSON();
  </script>
</body>
</html>
