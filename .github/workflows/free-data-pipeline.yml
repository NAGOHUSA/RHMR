# .github/workflows/free-data-pipeline.yml
name: Free Real Estate Data Pipeline

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
    - cron: "0 8,14,20 * * *"  # 3 times daily (8 AM, 2 PM, 8 PM UTC)
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  collect-free-data:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        zip: ['31088', '31093', '31098']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 pandas numpy
        echo "‚úÖ All dependencies installed"
    
    - name: Create directory structure
      run: |
        mkdir -p scripts
        mkdir -p data/houston-county-ga
        mkdir -p data/houston-county-ga/${{ matrix.zip }}
    
    - name: Collect free data
      run: |
        echo "Collecting free data for ZIP ${{ matrix.zip }}..."
        # Use fetch_real_time_data.py instead of free_data_collector.py
        if [ -f "scripts/fetch_real_time_data.py" ]; then
          python scripts/fetch_real_time_data.py
        else
          echo "‚ùå Error: fetch_real_time_data.py not found!"
          echo "Available scripts:"
          ls -la scripts/
          exit 1
        fi
    
    - name: Archive collected data
      run: |
        echo "üìÅ Data collected for ZIP ${{ matrix.zip }}"
        ls -la data/houston-county-ga/${{ matrix.zip }}/
    
    - name: Upload data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: data-${{ matrix.zip }}
        path: data/houston-county-ga/${{ matrix.zip }}
        retention-days: 7
  
  generate-ai-insights:
    runs-on: ubuntu-latest
    needs: collect-free-data
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all data artifacts
      run: |
        echo "üì• Downloading data artifacts..."
        mkdir -p data/houston-county-ga
    
    - name: Download artifact 31088
      uses: actions/download-artifact@v4
      with:
        name: data-31088
        path: data/houston-county-ga/31088
    
    - name: Download artifact 31093
      uses: actions/download-artifact@v4
      with:
        name: data-31093
        path: data/houston-county-ga/31093
    
    - name: Download artifact 31098
      uses: actions/download-artifact@v4
      with:
        name: data-31098
        path: data/houston-county-ga/31098
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 pandas numpy
        echo "‚úÖ Dependencies installed"
    
    - name: Process data
      run: |
        echo "üîÑ Processing collected data..."
        # Run your data processing scripts
        if [ -f "scripts/process_real_time_data.py" ]; then
          python scripts/process_real_time_data.py
        fi
        
        if [ -f "scripts/calculate_metrics.py" ]; then
          python scripts/calculate_metrics.py
        fi
    
    - name: Create dashboard JSON files
      run: |
        echo "üìä Creating dashboard JSON files..."
        if [ -f "scripts/create_dashboard_json.py" ]; then
          python scripts/create_dashboard_json.py
        else
          echo "‚ö†Ô∏è Warning: create_dashboard_json.py not found!"
        fi
    
    - name: Generate insights
      run: |
        echo "üí° Generating insights..."
        if [ -f "scripts/generate_insights.py" ]; then
          python scripts/generate_insights.py
        fi
    
    - name: Generate DeepSeek AI insights
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        echo "ü§ñ Generating AI insights..."
        if [ -f "scripts/deepseek_ai_insights.py" ]; then
          python scripts/deepseek_ai_insights.py
        else
          echo "‚ö†Ô∏è DeepSeek AI script not found, using fallback..."
        fi
    
    - name: Run complete pipeline
      run: |
        echo "üöÄ Running complete pipeline..."
        if [ -f "scripts/run_pipeline.py" ]; then
          python scripts/run_pipeline.py
        else
          echo "‚úÖ Individual scripts completed"
        fi
    
    - name: Verify generated files
      run: |
        echo "üìã Generated files:"
        ls -la data/houston-county-ga/*.json 2>/dev/null || echo "No dashboard files found"
        echo ""
        echo "üìÅ All files in data directory:"
        find data/houston-county-ga -type f | head -30
        echo ""
        echo "üìä File counts:"
        find data/houston-county-ga -type f -name "*.json" | wc -l
        echo "JSON files"
        find data/houston-county-ga -type f -name "*.txt" | wc -l
        echo "TXT files"
        find data/houston-county-ga -type f -name "*.csv" | wc -l
        echo "CSV files"
    
    - name: Upload dashboard artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-files
        path: |
          data/houston-county-ga/
        retention-days: 7
  
  deploy-dashboard:
    runs-on: ubuntu-latest
    needs: generate-ai-insights
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download dashboard artifacts
      uses: actions/download-artifact@v4
      with:
        name: dashboard-files
        path: data/houston-county-ga/
    
    - name: Setup git config
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config pull.rebase false
    
    - name: Pull latest changes
      run: |
        git pull origin main || echo "Pull failed, continuing..."
    
    - name: Commit and push data updates
      run: |
        # Add all data files
        git add data/
        
        # Check if there are any changes
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "üìä Automated data update $(date +'%Y-%m-%d %H:%M UTC')"
          git push origin main
          echo "‚úÖ Data pushed to repository"
        fi
    
    - name: Create simple HTML dashboard
      run: |
        echo "üåê Creating simple HTML dashboard..."
        mkdir -p docs
        
        # Create a basic index.html
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Real Estate Dashboard</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .header { background: #2c3e50; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                .container { display: flex; flex-wrap: wrap; gap: 20px; }
                .card { border: 1px solid #ddd; padding: 20px; border-radius: 5px; flex: 1; min-width: 300px; }
                .data-section { background: #f9f9f9; padding: 15px; border-radius: 3px; margin: 10px 0; }
                .success { color: #27ae60; }
                .error { color: #e74c3c; }
                pre { background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 3px; overflow-x: auto; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üè† Real Estate Market Dashboard</h1>
                <p>Automated data pipeline for Houston County, GA</p>
                <p><small>Updated: <span id="update-time">$(date)</span></small></p>
            </div>
            
            <div class="container">
                <div class="card">
                    <h2>üìä Pipeline Status</h2>
                    <div class="data-section">
                        <p><strong>Status:</strong> <span class="success">‚úì Running</span></p>
                        <p><strong>Last Run:</strong> <span id="last-run">$(date)</span></p>
                        <p><strong>Next Run:</strong> In 6 hours</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìç Coverage Areas</h2>
                    <div class="data-section">
                        <ul>
                            <li>ZIP 31088 - Warner Robins</li>
                            <li>ZIP 31093 - Centerville</li>
                            <li>ZIP 31098 - Bonaire</li>
                        </ul>
                        <p>Total properties tracked: <strong id="property-count">Loading...</strong></p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìÅ Data Files</h2>
                    <div class="data-section">
                        <p>Available JSON files:</p>
                        <div id="file-list">
                            <p>Loading file list...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üîó Quick Links</h2>
                <div class="data-section">
                    <ul>
                        <li><a href="https://github.com/NAGOHUSA/RHMR" target="_blank">GitHub Repository</a></li>
                        <li><a href="https://github.com/NAGOHUSA/RHMR/actions" target="_blank">Pipeline Runs</a></li>
                        <li><a href="data/houston-county-ga/" target="_blank">Raw Data Directory</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <h2>üìà Sample Data</h2>
                <div class="data-section">
                    <p>Latest dashboard data:</p>
                    <pre id="sample-data">Loading sample data...</pre>
                </div>
            </div>
            
            <script>
                // Update time dynamically
                document.getElementById('update-time').textContent = new Date().toLocaleString();
                
                // Try to load a sample data file
                fetch('data/houston-county-ga/dashboard_simple.json')
                    .then(response => {
                        if (!response.ok) throw new Error('File not found');
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('sample-data').textContent = 
                            JSON.stringify(data, null, 2).substring(0, 1000) + '...';
                        
                        if (data.market_overview) {
                            document.getElementById('property-count').textContent = 
                                data.market_overview.total_properties || 'N/A';
                        }
                    })
                    .catch(error => {
                        document.getElementById('sample-data').textContent = 
                            'Error loading dashboard data. Check data/houston-county-ga/ directory.';
                    });
                
                // List available files
                fetch('data/houston-county-ga/')
                    .then(response => response.text())
                    .then(html => {
                        // Simple parsing to get file list
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const links = doc.querySelectorAll('a');
                        let fileList = '';
                        links.forEach(link => {
                            if (link.href && !link.href.includes('?') && 
                                (link.href.endsWith('.json') || link.href.endsWith('.csv'))) {
                                fileList += `<li><a href="${link.href}" target="_blank">${link.textContent}</a></li>`;
                            }
                        });
                        document.getElementById('file-list').innerHTML = 
                            fileList ? `<ul>${fileList}</ul>` : '<p>No JSON/CSV files found</p>';
                    })
                    .catch(error => {
                        document.getElementById('file-list').innerHTML = 
                            '<p>Unable to load file list</p>';
                    });
            </script>
        </body>
        </html>
        EOF
        
        echo "‚úÖ HTML dashboard created at docs/index.html"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        keep_files: false
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
